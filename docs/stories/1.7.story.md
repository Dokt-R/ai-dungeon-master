# Story 1.7 - Campaign & Party Lifecycle Management

## Status
Approved

## Story
**As a** server owner or player,  
**I want** clear, consolidated commands to create, join, continue, end, and delete a campaign,  
**so that** I can easily manage my game sessions from a single command group.

## Acceptance Criteria
1. A user can create a new campaign using `/campaign new "[name]"`.
2. The bot provides instructions for other players to join using `/campaign join "[name]"`.
3. A user can resume the last played campaign using `/campaign continue`. The bot responds with the narrative from the last "clean save point".
4. Upon starting or continuing a campaign, the bot **must** display the message: "**Entering immersive role-playing mode. All messages from now on will be processed by the AI.**"
5. A user can end the current session using `/campaign end`. This triggers a final autosave.
6. Upon ending a campaign, the bot **must** display the message: "**Exiting immersive mode. Progress has been saved. You are now in command mode.**"
7. A user can delete a campaign using `/campaign delete "[name]"`, which will only proceed after the user confirms the action.
8. The bot responds to `/help` with a list of help topics (e.g., Campaign, Setup).
9. The bot responds to `/help <topic>` with detailed information for that topic.
10. After campaign creation or join, the bot guides the user through character setup (digital or physical sheet).
11. If a user disconnects unexpectedly, `/campaign continue` restores the last autosave without loss of progress.
12. Multiple players can join a campaign and register their characters, forming a party ready for gameplay.

## Tasks / Subtasks
- [x] Implement `/campaign new [name]` command in `campaign_cog.py` to create a new campaign and persist it in `data/campaigns/[campaign_name]/`. After creation, prompt the user for character setup (digital or physical sheet).
  (AC: 1, 10)
- [x] Implement `/campaign join [name]` command to allow players to join an existing campaign. Prompt for character setup.
  (AC: 2, 10, 12)
- [x] Implement `/campaign continue` command to resume the last active campaign and load the last clean save point. If user was disconnected, restore from autosave.
  (AC: 3, 11)
- [ ] Display explicit state transition message on campaign start/continue.  
  (AC: 4)
- [x] Implement `/campaign end` command to autosave and end the current session.  
  (AC: 5)
- [ ] Display explicit state transition message on campaign end.  
  (AC: 6)
- [ ] Implement `/campaign delete [name]` command with confirmation prompt.  
  (AC: 7)
- [ ] Refactor `/help` command to list help topics and implement `/help campaign` and `/help setup`.  
  (AC: 8, 9)
- [ ] Write unit tests for all new commands and backend logic using Pytest.
- [ ] Write integration tests to verify end-to-end campaign lifecycle flows, including autosave/restore and character onboarding.

## Dev Notes

- **Discord Permission Handling**:
  - All `/campaign` commands must enforce Discord permission checks. Only users with the required Discord roles (e.g., Manage Server, Administrator) or the campaign owner may perform sensitive actions such as deleting a campaign. Permission checks should be implemented at the command level using discord.py's built-in decorators and custom logic as needed.
  - [See: Security Considerations section]

- **User Flow & Sequence Diagrams for Contributors**:
  - For detailed user flows and sequence diagrams, see [docs/ui-ux-specification/user-flows.md](../ui-ux-specification/user-flows.md).
    - Relevant diagrams:
      - Flow: New Campaign & Character Creation
      - Flow: Forming a Campaign Party
      - Edge Cases & Error Handling
  - New contributors should review these diagrams to understand the expected user experience and system interactions.

- **Previous Story Insights**:
  - Campaign transcript logging is robust, modular, and follows best practices for async file I/O, error handling, and code organization. The separation between logging utility and message processing logic is clear. All log entries are structured as required, and the code is readable, maintainable, and well-tested.
  - [Source: stories/1.6.story.md#Dev Agent Record, #QA Results]

- **Data Models**:
  - `Campaign` model:
    - `campaign_id: str`
    - `server_id: str`
    - `name: str`
    - `active_player_ids: List[str]`
    - [Source: architecture/data-models.md#Campaign]
  - `PlayerCharacter` model:
    - `character_id: str`
    - `player_discord_id: str`
    - `campaign_id: str`
    - `name: str`
    - [Source: architecture/data-models.md#PlayerCharacter]

- **API Specifications**:
  - Server configuration API (for campaign-related settings) is implemented in FastAPI at `/servers/{server_id}/config` (PUT).
  - Uses Pydantic models for validation and error handling.
  - [Source: packages/backend/api/server_config.py]
  - No specific campaign management endpoints are defined; campaign logic is handled via bot commands and backend components.
  - [Source: architecture/index.md#API Specification]

- **Component Specifications**:
  - `CampaignManager`: Handles logic for creating, starting, ending, and deleting campaigns.
  - `PlayerManager`: Manages players joining a campaign and their associated character data.
  - `ServerSettingsManager`: Manages configuration for each Discord server.
  - [Source: architecture/components.md]
  - Discord bot commands should be implemented using the Cogs pattern in `packages/bot/cogs/campaign_cog.py`.
  - [Source: architecture/unified-project-structure.md#bot/cogs]

- **File Locations**:
  - Campaign logic: `packages/backend/components/campaign_manager.py`
  - Player management: `packages/backend/components/player_manager.py`
  - Discord bot commands: `packages/bot/cogs/campaign_cog.py`
  - Help command logic: `packages/bot/cogs/utility_cog.py`
  - Campaign data: `data/campaigns/[campaign_name]/`
  - [Source: architecture/unified-project-structure.md]

- **Testing Requirements**:
  - All new code must be covered by unit tests using Pytest.
  - Test files should be placed in `packages/backend/tests/` and `packages/bot/tests/`.
  - Integration tests should verify campaign creation, joining, continuation, ending, and deletion flows, including autosave/restore and character onboarding.
  - At least two Discord users: one with campaign owner or server admin permissions, and one regular player.
  - Distinct campaign names for creation, joining, and deletion scenarios.
  - Character data for onboarding flows (digital or physical sheet).
  - Test Discord server with the bot installed and required permissions granted (manage channels, manage messages, etc.).
  - Ensure test users have appropriate Discord roles to execute campaign commands.
  - [Source: architecture/testing-strategy.md]
  - [Source: architecture/key-strategies.md#Test Strategy]

- **Technical Constraints**:
  - Use Python 3.13, FastAPI for backend, discord.py for bot.
  - All code must be formatted with Black and linted with Ruff.
  - Use Pydantic models for all input validation.
  - All bot commands must use the tree command structure for Discord visibility.
  - [Source: architecture/tech-stack.md, architecture/key-strategies.md]
  - All data access must go through the appropriate abstraction layers (e.g., MemoryService).
  - [Source: architecture/key-strategies.md#Use the Abstraction Layers]
  - Explicit state transition messages must be shown on campaign start/continue and end, as per UX spec.
  - [Source: ui-ux-specification/transitions.md]

- **Command Structure & UX**:
  - `/campaign` commands: new, join, continue, end, delete (with confirmation).
  - `/help` and `/help <topic>` commands for user guidance.
  - [Source: ui-ux-specification/command-structure.md]
  - Explicit state transition messages:
    - On entry: "**Entering immersive role-playing mode. All messages from now on will be processed by the AI.**"
    - On exit: "**Exiting immersive mode. Progress has been saved. You are now in command mode.**"
    - [Source: ui-ux-specification/transitions.md]
  - After `/campaign new` or `/campaign join`, the bot must guide the user through character setup (digital or physical sheet).
    - [Source: ui-ux-specification/user-flows.md#Flow: New Campaign & Character Creation, #Flow: Forming a Campaign Party]
  - If a user disconnects, `/campaign continue` restores the last autosave.
    - [Source: ui-ux-specification/user-flows.md#Edge Cases & Error Handling]
  - Party formation: multiple users can join and register characters, with onboarding prompts.
    - [Source: ui-ux-specification/user-flows.md#Flow: Forming a Campaign Party]

- **Security Considerations**
  - Only authorized users (the campaign owner or a server admin) may delete campaigns.
    - The `/campaign delete` command must enforce this restriction and validate the user's permissions before proceeding with deletion.
  - All campaign management commands should check for appropriate Discord permissions (e.g., Manage Server, Administrator) as required by server policy.

## Change Log
| Date       | Version | Description                | Author |
|------------|---------|----------------------------|--------|
| 2025-08-01 | 1.0     | Initial draft (template compliance fix) | PO     |

## Dev Agent Record

### Agent Model Used
GPT-4.1 (bmad-dev)

### Debug Log References
- Implemented `/campaign new` as a subcommand of the `campaign` command group in [`campaign_cog.py`](packages/bot/cogs/campaign_cog.py).
- Created unit tests for `/campaign new` in [`test_campaign_cog.py`](packages/bot/tests/test_campaign_cog.py).
- Refactored command logic for testability and verified all tests pass.
- Implemented `/campaign join` as a subcommand and handler in [`campaign_cog.py`](packages/bot/cogs/campaign_cog.py).
- Created and validated unit tests for `/campaign join` in [`test_campaign_cog.py`](packages/bot/tests/test_campaign_cog.py).
- Created minimal [`player_manager.py`](packages/backend/components/player_manager.py) for player join logic.
- Implemented `/campaign continue` as a subcommand and handler in [`campaign_cog.py`](packages/bot/cogs/campaign_cog.py) using API and DB.
- Created and validated unit tests for `/campaign continue` in [`test_campaign_cog.py`](packages/bot/tests/test_campaign_cog.py).
- Backend API and [`campaign_manager.py`](packages/backend/components/campaign_manager.py) now use [`server_settings_manager.py`](packages/backend/components/server_settings_manager.py) and SQLite for all campaign state.

### Completion Notes List
- `/campaign new [name]` implemented as a structured subcommand with permission checks, campaign directory creation, and character setup prompt. Unit tests cover success, duplicate, permission, and backend error cases. All tests pass.
- `/campaign join [name]` implemented as a structured subcommand with campaign existence check, player join logic, and character setup prompt. Unit tests cover success, non-existent campaign, and backend error. All tests pass.
- `/campaign continue` implemented as a structured subcommand with API and DB-backed state, narrative retrieval, and error handling. Unit tests cover success, non-existent campaign, and backend error. All tests pass.

### File List
- packages/bot/cogs/campaign_cog.py
- packages/bot/tests/test_campaign_cog.py
- packages/backend/components/player_manager.py
- packages/backend/components/campaign_manager.py
- packages/backend/components/server_settings_manager.py
- packages/backend/api/campaign_api.py

## QA Results
<!-- To be completed after implementation -->
